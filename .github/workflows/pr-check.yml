name: PR Quality Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
    - name: Check PR title format
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          refactor
          test
          chore
        scopes: |
          audiobook
          metadata
          ui
          database
          api
          indexer
          quality
          migration
        requireScope: false

    - name: Check PR size
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const additions = pr.additions;
          const deletions = pr.deletions;
          const filesChanged = pr.changed_files;

          // Warn if PR is too large
          if (additions + deletions > 1000) {
            core.warning(`Large PR: ${additions + deletions} lines changed. Consider splitting.`);
          }

          // Enforce minimum density (from CLAUDE.md)
          if (filesChanged < 3 && additions < 50) {
            core.setFailed('PR too small - batch with other work per CLAUDE.md PR density rules');
          }

    - name: Check for AI indicators
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const body = pr.body || '';
          const title = pr.title || '';

          const aiIndicators = [
            'Co-authored-by: Claude',
            'Generated with Claude',
            'ðŸ¤–',
            'AI-generated',
            'comprehensive',
            'robust solution',
            'enhance the',
            'leverage',
            'streamline'
          ];

          const found = aiIndicators.filter(indicator =>
            body.toLowerCase().includes(indicator.toLowerCase()) ||
            title.toLowerCase().includes(indicator.toLowerCase())
          );

          if (found.length > 0) {
            core.setFailed(`AI indicators detected: ${found.join(', ')}\nRemove per CLAUDE.md AI Attribution rules`);
          }
