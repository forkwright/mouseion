name: PR Quality Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
    - name: Check PR title format
      uses: amannn/action-semantic-pull-request@e32d7e603df1aa1ba07e981f2a23455dee596825 # v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          refactor
          test
          chore
        scopes: |
          audiobook
          metadata
          ui
          database
          api
          indexer
          quality
          migration
        requireScope: false

    - name: Check PR size
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const additions = pr.additions;
          const deletions = pr.deletions;
          const filesChanged = pr.changed_files;

          // Warn if PR is too large
          if (additions + deletions > 1000) {
            core.warning(`Large PR: ${additions + deletions} lines changed. Consider splitting.`);
          }

          // Warn about low PR density
          const totalChanges = additions + deletions;
          if (filesChanged === 1 && totalChanges < 10) {
            core.warning('Consider batching: 1 file with <10 lines changed. Prefer denser PRs when possible.');
          } else if (filesChanged === 2 && totalChanges < 20) {
            core.warning('Consider batching: 2 files with <20 lines changed. Prefer denser PRs when possible.');
          }

    - name: Check for AI indicators
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const body = pr.body || '';
          const title = pr.title || '';

          const aiIndicators = [
            'Co-authored-by: Claude',
            'Generated with Claude',
            'ðŸ¤–',
            'AI-generated',
            'comprehensive',
            'robust solution',
            'enhance the',
            'leverage',
            'streamline'
          ];

          const found = aiIndicators.filter(indicator =>
            body.toLowerCase().includes(indicator.toLowerCase()) ||
            title.toLowerCase().includes(indicator.toLowerCase())
          );

          if (found.length > 0) {
            core.setFailed(`AI indicators detected: ${found.join(', ')}\nRemove per CLAUDE.md AI Attribution rules`);
          }
